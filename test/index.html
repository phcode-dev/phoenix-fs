<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Mocha Tests distribution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css"/>
    <script>
        window.addEventListener('keydown', function(event) {
            if (event.key === 'F5') {
                location.reload();
            }
        });
        const TEST_TYPE_FS_ACCESS = "fs access";
        const TEST_TYPE_FILER = "filer";
        const TEST_TYPE_TAURI = "tauri";
    </script>
    <script src="https://unpkg.com/chai/chai.js"></script>
    <script src="https://unpkg.com/mocha/mocha.js"></script>

    <script class="mocha-init">
        mocha.setup('bdd');
        mocha.checkLeaks();
    </script>

    <script src="virtualfs.js"></script>
    <script src="testInit.js"></script>
    <script src="test.browser.js"></script>
    <script src="test-copy.browser.js"></script>
    <script src="test.worker.js"></script>
    <script src="test-getPlatformPath-api.browser.js"></script>
    <script class="mocha-exec">
        window.virtualTestPath = '/test-phoenix-fs';

        function observerRunStatus(runner) {
            if(!__TAURI__){
                return;
            }
            console.log("setting up tauri test reporters to log to system console.")
            function consoleLogToShell(message) {
                return __TAURI__.invoke("console_log", {message});
            }

            function quitIfNeeded() {
                __TAURI__.cli.getMatches().then(matches=>{
                    if(matches?.args["quit-when-done"]?.occurrences) {
                        __TAURI__.process.exit(0)
                    }
                });
            }

            runner.on('end', function() {
                const stats = runner.stats;
                if (stats.failures > 0) {
                    consoleLogToShell(`\u2716 ${stats.failures} tests failed of ${stats.tests} tests in ${stats.suites} suites!. Time: ${stats.duration} ms`)
                        .finally(quitIfNeeded);
                } else {
                    consoleLogToShell(`\u2714 All(${stats.tests}) tests passed in in ${stats.suites} suites! Time: ${stats.duration} ms`)
                        .finally(quitIfNeeded);
                }
            });
            runner.on('suite', (suite) => {
                consoleLogToShell(`\nSuite started: ${suite.title}\n`);
            });

            runner.on('pass', function(test) {
                consoleLogToShell(`\u2714 '${test.title}' passed!`);
            });

            runner.on('fail', function(test, err) {
                consoleLogToShell(`\u2716 Test '${test.title}' failed! \nReason: ${err.message} \n${err.stack}`);
            });

            runner.on('pending', function(test) {
                consoleLogToShell(`Test '${test.title}' was skipped.`);
            });
        }
        function openFolderAndRunTests() {
            function mountNative() {
                fs.mountNativeFolder((err, mountTestPath)=>{
                    if(!mountTestPath[0]) return;
                    localStorage.setItem('mountTestPath', mountTestPath[0]);
                    document.getElementById('openFolderButton').style = "display:none";
                    window.mountTestPath = `${mountTestPath[0]}/test`;
                    observerRunStatus(mocha.run());
                });
            }

            let mountTestPath = localStorage.getItem('mountTestPath');
            if(!mountTestPath) {
                mountNative();
                return;
            }
            fs.readdir(mountTestPath, (err, contents)=>{
                console.log("Checking if any mounted paths exists: ",err, contents);
                if(err){
                    mountNative();
                    return;
                }
                window.mountTestPath = `${mountTestPath}/test-phoenix-fs`;
                document.getElementById('openFolderButton').style = "display:none";
                observerRunStatus(mocha.run());
            });
        }
        function runTauriTests() {
            if(window.__TAURI__){
                window.tauriTests = true;
                console.log("Tauri env detected. running tauri specific tests.");
                document.getElementById('openFolderButton').style = "display:none";
                observerRunStatus(mocha.run());
            }
        }
    </script>
</head>
<body onload="runTauriTests()">
<div id="mocha"></div>
<button id="openFolderButton" onclick="openFolderAndRunTests()">Open any blank folder to start tests. Warning - folder contents will be deleted!!!!</button>
</body>
</html>
